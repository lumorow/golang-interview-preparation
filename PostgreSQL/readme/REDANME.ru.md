# PostgreSQL

В Postgres Pro транзакция определяется набором SQL-команд, окружённым командами `BEGIN` и `COMMIT`.
Таким образом, наша банковская транзакция должна была бы выглядеть так:

```sql
BEGIN;
UPDATE accounts SET balance = balance - 100.00
WHERE name = 'Alice';
-- ...
COMMIT;
```
Если в процессе выполнения транзакции мы решим, что не хотим фиксировать её изменения (например, потому что оказалось,
что баланс Алисы стал отрицательным), мы можем выполнить команду `ROLLBACK` вместо `COMMIT`, и все наши изменения будут
отменены.

Postgres Pro на самом деле отрабатывает каждый SQL-оператор как транзакцию. Если вы не вставите команду `BEGIN`,
то каждый отдельный оператор будет неявно окружён командами `BEGIN` и `COMMIT` (в случае успешного завершения).
Группу операторов, окружённых командами `BEGIN` и `COMMIT` иногда называют блоком транзакции.

## ACID или 4 свойства транзакций

Прежде чем приступим к рассмотрению уровней изоляции транзакции в паре слов вспомним об основных требованиях к транзакционной системе.

- `Atomicity` (атомарность) — выражается в том, что транзакция должна быть выполнена в целом или не выполнена вовсе.

- `Consistency` (согласованность) — гарантирует, что по мере выполнения транзакций, данные переходят из одного согласованного состояния
в другое, то есть транзакция не может разрушить взаимной согласованности данных.

- `Isolation` (изолированность) — локализация пользовательских процессов означает, что конкурирующие за доступ к БД транзакции физически обрабатываются последовательно,
изолированно друг от друга, но для пользователей это выглядит, как будто они выполняются параллельно.

- `Durability` (долговечность) — устойчивость к ошибкам — если транзакция завершена успешно, то те изменения в данных, которые были ею произведены, не могут быть потеряны ни при каких обстоятельствах.

## Транзакции и уровни изоляций

Стандарт описывает следующие особые условия, недопустимые для различных уровней изоляции:

- `«Грязное» чтение`. Транзакция читает данные, записанные параллельной незавершённой транзакцией.

- `Неповторяемое чтение`. Транзакция повторно читает те же данные, что и раньше, и обнаруживает, что они были изменены другой транзакцией (которая завершилась после первого чтения).

- `Фантомное чтение`. Транзакция повторно выполняет запрос, возвращающий набор строк для некоторого условия, и обнаруживает, что набор строк, удовлетворяющих условию, изменился из-за транзакции, завершившейся за это время.

- `Аномалия сериализации`. Результат успешной фиксации группы транзакций оказывается несогласованным при всевозможных вариантах исполнения этих транзакций по очереди.



| Уровень изоляции                                    | «Грязное» чтение        | Неповторяемое чтение  | Фантомное чтение        | Аномалия сериализации  |
|-----------------------------------------------------|-------------------------|-----------------------|-------------------------|------------------------|
| `Read uncommited` (Чтение незафиксированных данных) | Допускается, но не в PG | Возможно              | Возможно                | Возможно               |
| `Read committed` (Чтение зафиксированных данных)    | Невозможно              | Возможно              | Возможно                | Возможно               |
| `Repeatable read` (Повторяемое чтение)              | Невозможно              | Невозможно            | Допускается, но не в PG | Возможно               |
| `Serializable` (Сериализуемость)                    | Невозможно              | Невозможно            | Невозможно              | Невозможно             |

## Индексы в PostgreSQL

Для повышения производительности поиска создаются вспомогательные структуры — индексы. Используя индексы,
можно существенно поднять скорость поиска, потому что данные в индексе хранятся в форме, позволяющей нам в процессе
поиска не рассматривать области, которые заведомо не могут содержать искомые элементы.

PostgreSQL поддерживает разные типы индексов для разных задач:

- `B-дерево` покрывает широчайший класс задач, т. к. применимо к любым данным, которые можно отсортировать.
- `GiST` и `SP-GiST` могут быть полезны при работе с геометрическими объектами и для создания совершенно новых типов индексов
для новых типов данных.
- За рамками этой статьи оказался ещё один важный тип индексов — `GIN`. `GIN` индексы полезны для организации полнотекстового
поиска и для индексации таких типов данных, как массивы или `jsonb`.


## Дополнительный материал
- [Изоляция транзакций в PostgreSQL (DEV Meetup November 2019)](https://www.youtube.com/watch?v=h4-o0kQz5lo&t=11s&ab_channel=QAHub)
- [Изоляция транзакций (PostgresPro)](https://postgrespro.ru/docs/postgrespro/9.5/transaction-iso)
- [Уровни изоляции транзакций с примерами на PostgreSQL (habr)](https://habr.com/ru/articles/317884/)
- [Индексы в PostgreSQL — 1 (habr)](https://habr.com/ru/companies/postgrespro/articles/326096/)
- [Индексы в PostgreSQL](https://tproger.ru/articles/indeksy-v-postgresql)
- [Индексы в PostgreSQL — 3 (habr)](https://habr.com/ru/companies/postgrespro/articles/328280/)

## README.md

- eng [English](https://github.com/lumorow/golang-interview-preparation/blob/main/PosgreSQL/README.md)
- ru [Русский](https://github.com/lumorow/golang-interview-preparation/blob/main/PosgreSQL/readme/README.ru.md)
